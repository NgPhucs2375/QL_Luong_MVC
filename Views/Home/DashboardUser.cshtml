@using QL_Luong_MVC.Models
@{
    ViewBag.Title = "Tổng quan cá nhân";
    Layout = "~/Views/Shared/_LayoutNhanVien.cshtml";
    bool isCheckedIn = ViewBag.IsCheckedIn ?? false;

    // MÀU SẮC THEME
    var primaryGreenDark = "rgb(77, 102, 72)";
    var secondaryGreenLight = "rgb(130, 140, 110)";
    var darkBrown = "rgb(82, 60, 52)";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* CSS cũ giữ nguyên */
    .card-check-in { background: linear-gradient(135deg, @darkBrown 0%, @secondaryGreenLight 100%) !important; color: white; }
    .btn-gold-primary { background-color: @primaryGreenDark !important; border-color: @primaryGreenDark !important; color: #fff !important; font-weight: 700 !important; }
    .text-warning-gold { color: @primaryGreenDark !important; }
    .text-primary-charcoal { color: @darkBrown !important; }
</style>

<div class="container-fluid py-2">

    <div class="row mb-4">
        <div class="col-lg-4 mb-4">
            <div class="card shadow border-0 h-100 card-check-in">
                <div class="card-body text-center p-5 d-flex flex-column justify-content-center">
                    <h3 class="font-weight-bold mb-1" style="font-family: 'Playfair Display', serif;">@DateTime.Now.ToString("dd MMMM, yyyy")</h3>
                    <p class="mb-4 text-white-50">Chúc bạn một ngày làm việc hiệu quả!</p>

                    @if (!isCheckedIn)
                    {
                        <div class="display-1 mb-3"><i class="fas fa-fingerprint" style="color: rgba(255,255,255,0.5)"></i></div>
                        <form action="@Url.Action("CheckIn", "Home")" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-gold-primary btn-lg rounded-pill px-5 shadow-lg">CHẤM CÔNG VÀO</button>
                        </form>
                    }
                    else
                    {
                        <div class="display-1 mb-3"><i class="fas fa-check-circle text-white"></i></div>
                        <button class="btn btn-light btn-lg rounded-pill px-5 font-weight-bold disabled" style="opacity:0.9">ĐÃ ĐIỂM DANH</button>
                        <p class="mt-3 small text-white-50">Giờ vào: @DateTime.Now.ToString("HH:mm")</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2" style="border-left-color: @primaryGreenDark !important;">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-uppercase mb-1 text-warning-gold">Ngày công tháng này</div>
                                    <div class="h3 mb-0 font-weight-bold text-gray-800">@ViewBag.SoNgayCong <span class="text-xs text-muted">/ 26</span></div>
                                </div>
                                <div class="col-auto"><i class="fas fa-calendar-alt fa-2x text-gray-300"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Tăng ca tích lũy</div>
                                    <div class="h3 mb-0 font-weight-bold text-gray-800">@ViewBag.GioTangCa <span class="text-xs text-muted">giờ</span></div>
                                </div>
                                <div class="col-auto"><i class="fas fa-clock fa-2x text-gray-300"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary-charcoal">Biến động thu nhập (6 tháng gần nhất)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area" style="height: 300px;">
                        <canvas id="salaryHistoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-primary-charcoal">Cơ cấu thu nhập tháng này</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2" style="height: 250px;">
                        <canvas id="incomeStructureChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2"><i class="fas fa-circle text-success"></i> Lương CB</span>
                        <span class="mr-2"><i class="fas fa-circle text-info"></i> Phụ cấp</span>
                        <span class="mr-2"><i class="fas fa-circle text-warning"></i> Tăng ca</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-primary-charcoal">Hoạt động chấm công gần đây</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        @if (ViewBag.RecentActivities != null)
                        {
                            foreach (var item in ViewBag.RecentActivities as List<QL_Luong_MVC.Models.BangChamCong>)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle text-xs mr-2 @(item.GioTangCa > 0 ? "text-warning" : "text-success")"></i>
                                        <span class="font-weight-bold text-dark">@item.Day_ChamCong.ToString("dd/MM/yyyy")</span>
                                        <span class="small text-muted ml-2">
                                            @(item.GioTangCa > 0 ? $"Tăng ca {item.GioTangCa}h" : "Hành chính")
                                        </span>
                                    </div>
                                    <span class="badge badge-light">@item.DayCong_ChamCong công</span>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- CẤU HÌNH DỮ LIỆU AN TOÀN (FIX LỖI DẤU PHẨY) ---
        // Sử dụng Json.Encode để C# tự động chuyển số thành định dạng chuẩn (ví dụ: 1000.5 thay vì 1000,5)
        var salaryLabels = @Html.Raw(Json.Encode(ViewBag.SalaryHistoryLabels));
        var salaryValues = @Html.Raw(Json.Encode(ViewBag.SalaryHistoryValues));

        var luongCB = @Html.Raw(Json.Encode(ViewBag.PieLuongCB ?? 0));
        var phuCap = @Html.Raw(Json.Encode(ViewBag.PiePhuCap ?? 0));
        var tangCa = @Html.Raw(Json.Encode(ViewBag.PieTangCa ?? 0));

        console.log("Dữ liệu biểu đồ:", { luongCB, phuCap, tangCa, salaryValues }); // Bật F12 để xem log này

        // --- 1. BIỂU ĐỒ CỘT: LỊCH SỬ LƯƠNG ---
        var ctxBar = document.getElementById("salaryHistoryChart");
        if (ctxBar) {
            // Nếu không có dữ liệu lịch sử, tạo mảng 0 để tránh lỗi
            if (!salaryValues || salaryValues.length === 0) {
                salaryLabels = ["T7", "T8", "T9", "T10", "T11", "T12"];
                salaryValues = [0, 0, 0, 0, 0, 0];
            }

            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: salaryLabels,
                    datasets: [{
                        label: "Thực nhận",
                        backgroundColor: "rgb(77, 102, 72)",
                        hoverBackgroundColor: "rgb(130, 140, 110)",
                        data: salaryValues,
                        barPercentage: 0.5,
                        borderRadius: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return value.toLocaleString('vi-VN') + ' đ'; }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- 2. BIỂU ĐỒ TRÒN: CƠ CẤU THU NHẬP ---
        var ctxPie = document.getElementById("incomeStructureChart");
        if (ctxPie) {
            // Kiểm tra nếu tổng bằng 0 thì hiển thị thông báo thay vì vẽ
            if (luongCB + phuCap + tangCa === 0) {
                // Vẽ một biểu đồ rỗng màu xám để báo hiệu
                new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: ["Chưa có dữ liệu"],
                        datasets: [{ data: [1], backgroundColor: ["#e3e6f0"] }]
                    },
                    options: { cutout: '70%', plugins: { tooltip: { enabled: false } } }
                });
            } else {
                new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: ["Lương CB", "Phụ cấp", "Tăng ca (Ước tính)"],
                        datasets: [{
                            data: [luongCB, phuCap, tangCa],
                            backgroundColor: ['#1cc88a', '#36b9cc', '#f6c23e'],
                            hoverOffset: 4,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var val = context.parsed;
                                        return context.label + ': ' + val.toLocaleString('vi-VN') + ' đ';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
}