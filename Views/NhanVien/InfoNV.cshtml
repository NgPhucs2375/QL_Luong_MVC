@model QL_Luong_MVC.Models.NhanVien
@using QL_Luong_MVC.Models
@{
    ViewBag.Title = "Hồ sơ nhân sự";
    Layout = "~/Views/Shared/_LayoutNhanVien.cshtml";

    // Lấy dữ liệu phụ cấp từ Controller (đã fix)
    var listPhuCap = ViewBag.ListPhuCap as List<PhuCap>;
    decimal tongPhuCap = ViewBag.TongPhuCap ?? 0;

    Func<bool> CheckCanViewSalary = () =>
    {
        var role = Session["Quyen"]?.ToString();
        var currentID = Session["MaNV"]?.ToString();

        // Admin, Kế toán, hoặc chính chủ nhân của hồ sơ này được xem
        return role == "Admin" || role == "KeToan" || currentID == Model.IDNhanVien.ToString();
    };
}

<style>
    /* ... (Giữ nguyên style cũ) ... */
    /* Thêm style mới cho danh sách phụ cấp */
    .list-group-item-phucap {
        background-color: transparent;
        border: none;
        border-bottom: 1px dashed rgba(130, 140, 110, 0.3);
        padding: 0.75rem 0;
    }

        .list-group-item-phucap:last-child {
            border-bottom: none;
        }
</style>

<div class="container-fluid py-4 fade-in-content">
    <div class="card border-0 shadow-lg" style="border-radius: 16px;">
        <div class="profile-header-bg mb-5">
            <div class="profile-avatar"><i class="fas fa-user-tie"></i></div>
        </div>

        <div class="card-body text-center pt-0 px-5 pb-5">
            <h3 class="font-weight-bold text-dark-charcoal">@Model.FullNameNhanVien</h3>
            <p class="text-muted mb-4">
                <span class="badge badge-pill badge-light text-muted border px-3 py-1 mr-2">Mã NV: #@Model.IDNhanVien</span>
                <span class="badge badge-pill @(Model.State_NhanVien == "Đang làm" ? "badge-success" : "badge-secondary") px-3 py-1">@Model.State_NhanVien</span>
            </p>

            <div class="row text-left mt-5">
                <div class="col-md-6 mb-4">
                    <h6 class="font-weight-bold text-section-title mb-3 border-bottom pb-2">
                        <i class="fas fa-address-card mr-2"></i>Thông tin cá nhân
                    </h6>
                    <div class="row mb-2"><div class="col-4 data-label">Email</div><div class="col-8 data-value">@Model.Email_NhanVien</div></div>
                    <div class="row mb-2"><div class="col-4 data-label">Điện thoại</div><div class="col-8 data-value">@Model.SDT_NhanVien</div></div>
                    <div class="row mb-2"><div class="col-4 data-label">Địa chỉ</div><div class="col-8 data-value">@Model.Address_NhanVien</div></div>
                </div>

                <div class="col-md-6 mb-4">
                    <h6 class="font-weight-bold text-section-title mb-3 border-bottom pb-2">
                        <i class="fas fa-briefcase mr-2"></i>Công việc & Chế độ
                    </h6>

                    <div class="row mb-2">
                        <div class="col-4 data-label">Phòng ban</div>
                        <div class="col-8 data-value"><span class="badge badge-info px-3 py-1">@ViewBag.TenPhongBan</span></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 data-label">Chức vụ</div>
                        <div class="col-8 data-value"><span class="badge badge-primary px-3 py-1">@ViewBag.TenChucVu</span></div>
                    </div>

                    @if (CheckCanViewSalary())
                    {
                        <div class="mt-4 p-3 rounded" style="background-color: #fcfbf8; border: 1px solid rgba(130, 140, 110, 0.2);">

                            <div class="row mb-2">
                                <div class="col-5 data-label text-dark-charcoal">Lương cơ bản</div>
                                <div class="col-7 data-value font-weight-bolder text-success text-right">
                                    @(Model.LuongHienTai.ToString("N0")) ₫
                                </div>
                            </div>

                            <hr class="my-2" style="border-color: rgba(130, 140, 110, 0.2);">

                            <div class="mb-2">
                                <div class="data-label mb-1">Các khoản phụ cấp:</div>
                                @if (listPhuCap != null && listPhuCap.Count > 0)
                                {
                                    <ul class="list-group list-group-flush pl-2">
                                        @foreach (var pc in listPhuCap)
                                        {
                                            <li class="list-group-item-phucap d-flex justify-content-between align-items-center">
                                                <span class="text-muted small"><i class="fas fa-check mr-1 text-success"></i> @pc.Loai_PhuCap</span>
                                                <span class="font-weight-bold text-dark">+@pc.SoTien_PhuCap.ToString("N0") ₫</span>
                                            </li>
                                        }
                                    </ul>
                                    <div class="row mt-2 pt-2 border-top">
                                        <div class="col-6 data-label">Tổng phụ cấp</div>
                                        <div class="col-6 text-right font-weight-bold text-primary">
                                            +@tongPhuCap.ToString("N0") ₫
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted small font-italic ml-2 mb-0">Không có phụ cấp.</p>
                                }
                            </div>

                            <div class="row mt-3 pt-3" style="border-top: 2px solid var(--primary-green-dark);">
                                <div class="col-5 data-label text-dark-charcoal font-weight-bold">Tổng chế độ</div>
                                <div class="col-7 text-right">
                                    <span class="h5 font-weight-bold text-danger">
                                        @((Model.LuongHienTai + tongPhuCap).ToString("N0")) ₫
                                    </span>
                                    <small class="d-block text-muted">(Chưa tính tăng ca/thưởng)</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @if (Session["Quyen"]?.ToString() == "Admin" || Session["Quyen"]?.ToString() == "NhanSu" || Session["MaNV"]?.ToString() == Model.IDNhanVien.ToString())
            {
                <div class="text-center mt-5">
                    <a href="@Url.Action("EditProfile")" class="btn btn-primary rounded-pill px-5 shadow-sm font-weight-bold">
                        <i class="fas fa-edit mr-2"></i> CẬP NHẬT HỒ SƠ
                    </a>
                </div>
            }
        </div>
    </div>
</div>